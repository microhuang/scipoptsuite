# this local Makefile includes the cluster targets

OPTHOST	   	 := $(shell uname -n | sed 's/\(.zib.de\)//g' | tr -cd '[:alpha:]')

-include $(SCIPDIR)/make/local/make.$(OPTHOST)

.PHONY: testcluster
testcluster:
		cd check; \
		$(SHELL) ./check_cluster.sh $(TEST) $(MAINFILE) $(SETTINGS) \
		$(notdir $(MAINFILE)) $(TIME) $(NODES) $(MEM) \
		$(THREADS) $(FEASTOL) $(LPS) $(DISPFREQ) $(CONTINUE) \
		$(QUEUETYPE) $(QUEUE) $(PPN) $(CLIENTTMPDIR) \
		$(NOWAITCLUSTER) $(EXCLUSIVE) $(PERMUTE) $(OPTCOMMAND);

.PHONY: testclustercpx
testclustercpx:
		cd check; \
		$(SHELL) ./check_cluster_cplex.sh $(TEST) $(CPLEX) $(SETTINGS) \
		$(OSTYPE).$(ARCH) $(TIME) $(NODES) $(MEM) \
		$(THREADS) $(FEASTOL) $(DISPFREQ) $(CONTINUE) $(QUEUETYPE) $(QUEUE) $(PPN) \
		$(CLIENTTMPDIR) $(NOWAITCLUSTER) $(EXCLUSIVE);

.PHONY: testclustercbc
testclustercbc:
		cd check; \
		$(SHELL) ./check_cluster_cbc.sh $(TEST) $(CBC) $(SETTINGS) \
		$(OSTYPE).$(ARCH) $(TIME) $(NODES) $(MEM) \
		$(THREADS) $(FEASTOL) $(CONTINUE) $(QUEUETYPE) $(QUEUE) $(PPN) \
		$(CLIENTTMPDIR) $(NOWAITCLUSTER) $(EXCLUSIVE);

.PHONY: testclustergurobi
testclustergurobi:
		cd check; \
		$(SHELL) ./check_cluster_gurobi.sh $(TEST) $(GUROBI) $(SETTINGS) \
		$(OSTYPE).$(ARCH) $(TIME) $(NODES) $(MEM) \
		$(THREADS) $(FEASTOL) $(DISPFREQ) $(CONTINUE) $(QUEUETYPE) $(QUEUE) $(PPN) \
		$(CLIENTTMPDIR) $(NOWAITCLUSTER) $(EXCLUSIVE);

.PHONY: testgamscluster
testgamscluster:
		cd check; \
		$(SHELL) ./check_gamscluster.sh $(TEST) $(GAMS) "$(GAMSSOLVER)" $(SETTINGS) \
		$(OSTYPE).$(ARCH) $(TIME) $(NODES) $(MEM) "$(GAP)" $(THREADS) $(CONTINUE) \
		"$(CONVERTSCIP)" $(QUEUETYPE) $(QUEUE) $(PPN) $(CLIENTTMPDIR) $(NOWAITCLUSTER) $(EXCLUSIVE);


SCIPEXAMPLES	=	Binpacking CallableLibrary Coloring Eventhdlr GMI LOP MIPSolver Scheduler TSP VRP

.PHONY: testexamples
testexamples:
		@$(foreach EXAMPLE, $(SCIPEXAMPLES), $(MAKE) -C examples/$(EXAMPLE) $^ test || exit 1;)

.PHONY: docexamples
docexamples:
		@$(foreach EXAMPLE, $(SCIPEXAMPLES), $(MAKE) -C examples/$(EXAMPLE) $^ doc || exit 1;)

.PHONY: coverage
coverage:
		-ln -s ../../../../src $(OBJDIR)/lib/scip
		-ln -s ../../../../src $(OBJDIR)/lib/tclique
		-ln -s ../../../../src $(OBJDIR)/lib/dijkstra
		-ln -s ../../../../src $(OBJDIR)/lib/blockmemshell
		-ln -s ../../../../src $(OBJDIR)/lib/nlpi
		-ln -s ../../../../src $(OBJDIR)/lib/xml
		-mkdir -p gcov
		lcov -d $(OBJDIR) -z
		make  $^ test
		lcov -d $(OBJDIR) -c >gcov/scip.capture
		genhtml -o gcov gcov/scip.capture
